# SQED + Symbolic Starting States on vscale

A demonstration of Symbolic Quick Error Detection with Symbolic Starting States
for detection of hardware trojans.

This directory contains the example deployed on
[vscale](https://github.com/LGTMCU/vscale)
a small, in-order RISC-V processor implementation written in Verilog.

This codebases uses Mentor Questa Formal.

Much of this is based on work by Shashank Nuthakki.
This repository is a cleaned up version of Saranyuc3/Trojan-Counter.


## Setup:
    1. Run on rsg10.stanford.edu. Be sure to use ssh -Y to interact
       with the GUI
    2. `source setup.bashrc`


## Commands:
    - `make clean` to clean the workspace
    - `make workspace` to create a workspace
    - `make design` to pull in the design
    - `make compile` to compile the design
    - `make prove` to run the formal tools
    - `make gui` to visualize the results
      (you may need to manually open this using the output from `make prove`)
    - `make all` to run all of the above in proper sequence


## Demo
    - Open `toppipe.v`
    - Search "[TROJAN TRIGGER START]" to find the mechanism that activates the trojan
    - Search "[TROJAN PAYLOAD START]" to find the trojan's effect
    - `make all` to run the full formal verification process
    - The design will compile and Questa will begin running shortly after
    - On rsg10 with a typical 128b ticking time bomb trojan, it will take less than a few seconds for all assertions to fire


## Previous Notes by Shashank
    - qed_i_cache has been modified to have a shift-on-pop implementation of the
      queue instead of a circular buffer as suggested by Aaron (from mentor)

### Tracing a Fired Assertion
    - When running `make prove`, any "fired" assertions are violated
    - To observe the instruction sequence generated by the formal tool do
        `qformal ./output/formal_verify.db`
    - Follow the below steps to manually trace out the instruction sequence
         1) In the GUI select the assertion in the Properties window to view
            the counter example waveforms for that assertion
         2) In the design window select the qed module present in 
            spc_wrapper/spc/dec/ (double click on it to open the RTL)
         3) Add the qed_ifu_instruction signal (this gives the instruction
            sequence) to the wave form viewer by right clicking on the varible
            (line 5 in the RTL) and selecting 'add to window'
         4) Move the cursor through the clock cycles (in the wave form viewer)
            to see the different instructions in the bug trace
         5) Some other signals which are helpful for analysis:
            a) spc_wrapper/spc/dec/qed/mode
            b) register signals: spc_wrapper/spc/exu0/irf/irf_array/chk0/iregs
               (part of the property signals)
